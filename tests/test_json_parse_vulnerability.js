const fs = require('fs');
const path = require('path');
const { BishopScorer } = require('../scoring/score');

const TEST_FILE = path.join(__dirname, 'invalid_results.json');

// Create a file with invalid JSON content
fs.writeFileSync(TEST_FILE, '{ "incomplete": "json"');

console.log('üß™ Testing JSON Parse Vulnerability...');

const scorer = new BishopScorer();
let testFailed = false;

try {
  console.log('Attempting to load invalid JSON file...');
  scorer.loadResults(TEST_FILE);
  console.error('‚ùå Failed: loadResults should have thrown an error but did not.');
  testFailed = true;
} catch (error) {
  if (error instanceof SyntaxError) {
    console.error('‚ùå Failed: Caught raw SyntaxError from JSON.parse. The vulnerability still exists.');
    testFailed = true;
  } else if (error.message.startsWith('Failed to parse results file')) {
    console.log('‚úÖ Fix verified: Caught custom error handling:', error.message);
  } else {
    console.warn('‚ö†Ô∏è Caught unexpected error type:', error.constructor.name);
    console.warn('Message:', error.message);
    // Depending on strictness, this might be a failure or just a warning.
    // We'll treat it as a failure for strict validation of our specific fix.
     testFailed = true;
  }
} finally {
  // Cleanup
  if (fs.existsSync(TEST_FILE)) {
    fs.unlinkSync(TEST_FILE);
  }

  if (testFailed) {
      process.exit(1);
  } else {
      console.log('üéâ Test passed successfully.');
  }
}
